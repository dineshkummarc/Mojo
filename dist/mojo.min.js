/*
 * The Blast Mojo Framework
 *
 * Copyright (c) 2011 Blast Radius
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
function Request(d,a,c,b){this.paramsObj=d;this.callerObj=a;this.eventObj=c;this.controllerObj=b;}Request.prototype.getController=function(){return this.controllerObj;};Request.prototype.getContextElement=function(){return this.getController().getContextElement();};Request.prototype.getCaller=function(){return this.callerObj;};Request.prototype.getEvent=function(){return this.eventObj;};function Controller(){this.contextElement=null;this.controllerClass=null;this.delegates=[];this.events;return this;}Controller.prototype.onInit=function(){};Controller.prototype.initialize=function(b,c,d){var a=this;a.contextElement=b;a.controllerClass=c;a.params=d;$(a.events).each(function(i,h){var f=$(document),k=h[0],e=h[1],g=h[2],j=h[3];if(k=="context"){f=$(b);}$(f).delegate(e,g,function(l){var m=new Request({},this,l,a);if(typeof a.before!="undefined"&&typeof a.before[j]!="undefined"){a.before[j].call(a,m);}a.methods[j].call(a,m);if(typeof a.after!="undefined"&&typeof a.after[j]!="undefined"){a.after[j].call(a,m);}});});a.onInit();};Controller.prototype.getContextElement=function(){if(!this.contextElement){return null;}return this.contextElement;};Controller.prototype.bind=function(a){};Controller.prototype.addObservers=function(){};Controller.prototype.addCommands=function(){};Controller.prototype.addCommand=function(b,a){};function Application(){if(!this.options){this.options={};}var a=this,b=a.options;b.appSrc="js/";b.locale="en_CA";b.plugins=[];b.pluginSrc="js/lib/plugins/";b.environment="dev";b.selector=jQuery||(function(){throw new Error("Unable to find jQuery");})();a.siteMap=[];}Application.prototype.onComplete=function(){};Application.prototype.configure=function(a,c){if(arguments.length>1){this.options[a]=c;try{console.info("Configure: ",a," -> ",c);}catch(b){}return this;}else{return this.options[a];}};Application.prototype.map=function(a,d){var b=this;var c=$(a);c.each(function(e,f){b.siteMap.push({context:f,init:d});});d.call(this,b);return this;};Application.prototype.heal=function(){return this;};Application.prototype.setupController=function(c,b,f){var e=$(c);var d=MOJO.controllers[b];if(typeof d=="undefined"){throw new Error("Undefined Controller @ ",b);}d.initialize(c,b,f);var a={name:b,controller:d};if(typeof e.data("controllers")=="undefined"){e.data("controllers",[]);}$(c).data("controllers").push(a);if(typeof d.after!="undefined"&&d.after.Start!="undefined"){d.after.Start.call(d,null);}};Application.prototype.disconnectControllers=function(b){var a=this;$(a.siteMap).each(function(c,d){$(d.context).unbind();});b.apply(a);};Application.prototype.connectControllers=function(){var a=this;$(a.siteMap).each(function(c,b){if(a.options.environment=="dev"){try{console.log("Mapping: ",b.context);}catch(e){}}var d=b.init.call(this);$(d).each(function(g,l){var f=b.context,h=$(f),k=l.params,j=l.controller;if(!MOJO._loaded.length||$.inArray(l.controller,MOJO._loaded)==-1){MOJO.require(a.options.appSrc+(j.replace(/\./g,"/")+".js"),function(i){console.log("Loaded Controller: ",j);a.setupController(f,j,k);});}else{a.setupController(f,j,k);}MOJO._loaded.push(j);});});};Application.prototype.on=function(a,b){return function(){};};Application.prototype.getPlugins=function(c){var a=this,b=a.options.pluginSrc;$(a.options.plugins).each(function(d,e){MOJO.require(b+e+".js");});c.call(a);};Application.prototype.start=function(){var a=this;$(document).ready(function(){a.disconnectControllers(function(){if(a.options.plugins.length){a.getPlugins(function(){a.connectControllers();});}else{a.connectControllers();}a.onComplete();});});};function Service(b,c,a){this.name=b;this.uri=c;this.options=a;}Service.prototype.invoke=function(f,h,d){var a=this;var c=this.getOptions()||{},g=c.method||function(){var i="get";if(a.getName().match(/^get/i)){i="get";}else{if(a.getName().match(/^add|del|update/i)){i="post";}}return i;}(),e=this.uri||"/api",b=c.responseType||"JSON";if(c.template){e=$.tmpl(e,f);f=null;}$.ajaxSetup({dataTypeString:b,type:g,cache:c.cache||"false",contentType:"application/json; charset=utf-8"});$.ajax({url:e,data:f}).success(function(i){if(b=="JSON"){i=$.parseJSON(i);}if(typeof h=="function"){h.call(d,null,i);}else{d[h](null,i);}}).error(function(){h.call(d,"Unable to execute XHR",arguments);});};Service.prototype.getName=function(){return this.name;};Service.prototype.getURI=function(){return this.uri;};Service.prototype.getOptions=function(){return this.options;};var ServiceLocator={services:{},addService:function(a){this.services[a.name]=a;return this;},getService:function(a){return this.services[a];},removeService:function(a){delete this.services[a];},removeServices:function(){this.services={};}};var MOJO=function(){};MOJO._loaded=[];MOJO._resolvedNamespace=function(a){return MOJO._namespace._provided[""+a];};MOJO._namespace=function(d){var e=(""+d).split(/\./),g=e.length,f=[],c=window;if(!MOJO._namespace._provided){MOJO._namespace._provided={};}for(var b=0;b<g;b+=1){var a=e[b];if(!c[a]){f[b]=a;c[a]=function(){};MOJO._namespace._provided[f.join(".")]=c[a];}c=c[a];}return c;};MOJO.controllers={};MOJO.query=function(){return jQuery.apply(this,arguments);};MOJO.require=function(a,b){$.ajaxSetup({async:false});$.getScript(a,function(){if(b){b.apply(this,arguments);}});$.ajaxSetup({async:true});};MOJO.define=function(c,b){if(!MOJO.controllers){MOJO.controllers={};}var a=MOJO._namespace(c),a=b,d=new Controller(),a=$.extend(a,d);MOJO.controllers[c]=a;};MOJO.create=function(a){return new Application(a);};